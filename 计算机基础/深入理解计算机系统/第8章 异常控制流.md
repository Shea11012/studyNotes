# 异常控制流 （Exception Control Flow）ECF

ECF 发生在系统的各个层次：

- 硬件层，硬件检测到的事件会触发控制突然转移到异常处理程序。
- 操作系统层，内核通过上下文切换将控制从一个用户进程转移到另一个用户进程。
- 应用层，一个程序可以发送信号到另一个进程，而接受者会将控制突然转移到它的一个信号处理器程序

### 异常处理

在系统启动时，操作系统分配和初始化一张称为异常表的跳转表，此表包含了异常码对应的异常程序处理地址。异常表的起始地址放在一个异常基址寄存器（exception table base register）的特殊 CPU 寄存器中。

### 异常的类别

| 类别 | 原因                | 异步/同步 | 返回行为             |
| ---- | ------------------- | --------- | -------------------- |
| 中断 | 来自 I/O 设备的信号 | 异步      | 总是返回到下一条指令 |
| 陷阱 | 有意的异常          | 同步      | 总是返回到下一条指令 |
| 故障 | 潜在可恢复的错误    | 同步      | 可能返回到当前指令   |
| 终止 | 不可恢复的错误      | 同步      | 不会返回             |

### 进程

异常时允许操作系统内核提供进程（process）概念的基本构造块。

进程的定义：是一个执行中程序的实例。系统中的每个程序都运行在某个进程的上下文（context）中。上下文是由程序正确运行所需的状态组成的。这个状态包括存放在内存中的程序的代码和数据，它的栈，通用目的寄存器的内容，程序计数器，环境变量以及打开文件描述符的集合。

操作系统给每个进程提供了：

- 一个独立的逻辑控制流，它提供了一个假象，好像程序在独占使用处理器。
- 一个私有的地址空间，它提供了一个假象，好像程序在独占的使用内存系统。

#### 并发流

一个逻辑流的执行在时间上与另一个流重叠，称为并发流（concurrency flow）。

多个流并发的执行被称为并发（concurrency）。

一个进程和其他进程轮流运行的概念被称为多任务（multitasking）。

一个进程执行它的控制流的一部分的每一时间段叫做时间片（time slice）。因此，多任务也叫时间分片（time slicing）。

tips：**并发流的思想与流运行的处理器核数或者计算机数无关。如果两个流在时间上重叠，那么它们就是并发的，即使它们是运行在同一个处理器上。如果两个流并发的运行在不同的处理器核或者计算机上，那么就称它们为并行流（parallel flow），它们并行的运行（running in parallel），且并行的执行（parallel execution）。**

