# 第11章 可扩展性的 MySQL

>  将所有数据简单的放到单个 MySQL 服务器上，遇到性能瓶颈时，购买更高性能的机器，这被称为垂直扩展或向上扩展。
>
> 将任务分配到多台计算机上，这被称为水平扩展或向外扩展。

#### 向上扩展

优点：

- 单台服务器比多台服务器更容易维护和开发
- 向上扩展比向外扩展简单

缺点：

- 由于 MySQL 内部可扩展性问题，升级服务器配置到一定程度时会遇到 “收益递减点”，性价比会降低。
- 如果使用复制，当主库升级到高端硬件，一般不太可能配置出一台能够跟上主库的强大备库。
- 向上扩展也是由限制的。单服务器首先会达到读限制，特别是复杂的读查询，因为 MySQL 内部是单线程的只能使用一个 CPU，这种是花钱也无法提升多少性能的。
- 内存也会成为瓶颈，通常表现为高磁盘使用率。
- 大多数公有云中都无法获得性能非常强的服务器，如果应用变得非常庞大，就不能选择向上扩展。

#### 向外扩展

向外扩展（横向扩展或者水平扩展）策略划分为三个部分：复制、拆分、数据分片（sharding）

方法：

1. 最简单最常见的向外扩展是通过复制将数据分发到多个服务器上，然后将备库用于读查询。这种技术以读为主的应用很有效。

2. 数据分片

   > 将数据分隔成一小片，然后存储到不同的节点中。有一些全局的数据不会被分片（如：城市列表或登录数据）。全局数据一般存储在单个节点中，通常保存在 memcached 或 redis 中。
   >
   > 例：
   >
   > 如果一个应用预计有 1000 万用户，这是就无须对注册用户进行分片，可以将所有用户（或者活跃用户）放到内存中。但如果用户数达到 5 亿，则需要对用户数据进行分片。用户产生的内容，如文章和评论，就肯定会进行分片。

   **选择分区键**

   数据分片的最大挑战是查找和获取数据：如何查找数据取决于如何进行分片。

   选择分区键，需要尽可能的避免跨分片查询，也需要让分片足够小，以免过大的数据片导致问题。

   将数据分配到分片中有两种主要的方法：固定分配和动态分配。两种方法都需要一个分区函数，使用行的分区键值作为输入，返回存储该行的分片。

   **固定分配：**

   优点：简答，开销低，可以在应用中直接硬编码。

   缺点：

   - 如果分片很大且数量不多，就很难平衡不同分片间的负载。
   - 固定分片的方式无法自定义数据放到哪个分片，这多在分片间负载不均衡的应用来说尤其重要。一些数据可能比其他的更加活跃，如果这些热点数据都被分配到同一个分片中，固定分配就无法通过热点数据转移的方式来平衡负载。
   - 修改分片策略比较困难，因为需要重新分配已有的数据，会导致更新大量数据，并在分片间转移数据。

   **动态分配：**将每个数据单元映射到一个分片。

   ```mysql
   create tabler user_to_shard (
   	user_id int not null,
       shard_id int not null,
       primary key (user_id)
   );
   ```

   可以使用一张表做映射，使用 user_id 获得分片号，不存在就从目标分片找到并加入到表中。

   优点：

   - 可以对数据存储位置做细粒度的控制，使得均衡分配数据到分片更加容易

#### 通过多实例扩展

MySQL 当扩展到超过 24 个 CPU 核心或内存超过 128 GB 时，MySQL 的性能开始趋于平缓。

可以让数据分片足够小，以使每台机器上都能放置多个分片，每台服务器上运行多个实例，然后划分服务器硬件资源，将其分配给每个实例。



# 第12章 高可用性

高可用性是在宕机造成的损失与降低宕机时间所花费的成本之间取一个平衡。

**实现高可用性：**

- 通过适当配置、监控以及规范或安全保障措施来避免人为错误
- 尽量保证在发生宕机时能够快速恢复，常见策略：在系统中制造冗余，并且具备故障转移能力。

这两个维度的高可用性可以通过相关的度量来确定：

- 平均失效时间
- 平均恢复时间



# 第13章 云端 MySQL

