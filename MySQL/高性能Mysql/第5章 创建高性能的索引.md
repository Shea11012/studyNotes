# 索引的类型

在 MySQL 中，索引是在存储引擎层而不是服务器层实现的，所以没有统一的索引标准。

### MySQL 支持的索引类型：

#### B-Tree 索引

B-Tree 索引是按照顺序存储数据，所以可以使用 order by 和 group by 操作。

B-Tree 索引适用于全键值、键值范围或键前缀查找。前面所述索引对如下类型查询有效：

- 全值匹配：指是和索引中的所有列进行匹配
- 匹配最左前缀：指只使用索引的第一列
- 匹配列前缀：指只匹配某一列的值开头部分
- 匹配范围值
- 精确匹配某一列并范围匹配另外一列：指第一列全匹配，第二列范围匹配

B-Tree 索引限制：

- 不是按照索引的最左列开始查找，则无法使用索引
- 不能跳过索引中的列
- 如果查询中有某个列的范围查询，则其右边所有列都无法使用索引优化查找

#### 哈希索引

哈希索引基于哈希表实现，只有精确匹配索引所有列的查询才有效。对于每一行数据，存储引擎都会对所有的索引列计算一个哈希码，哈希码是一个较小的值，并且不同键值的行计算出来的哈希码也不一样。哈希索引将所有的哈希码存储在索引中，同时在哈希表中保存指向每个数据行的指针。

在 MySQL 中，只有 Memory 引擎显式支持哈希索引。

因为哈希索引只需存储对应的哈希值，所以索引结构十分紧凑，这也使得哈希索引查找的速度非常块。

哈希索引的限制：

- 哈希索引只包含哈希值和行指针，而不存储字段值，所以不能使用索引中的值来避免读取行。因为是访问内存中的行，所以大部分情况下对性能影响不明显。
- 哈希索引数据不是按照索引值顺序存储的，所以也无法用于排序。
- 哈希索引不支持部分索引列匹配查找，因为哈希索引始终是使用索引列的全部内容来计算哈希值。
- 哈希索引只支持等值比较查询，不支持任何范围查询。
- 访问哈希索引的数据非常快，除非有很多哈希冲突（不同的索引列值却有相同的哈希值）。出现哈希冲突时，存储引擎必须遍历链表中的所有行指针，逐行进行比较，直到找到所有符合条件的行。
- 哈希冲突很多的话，一些索引维护操作代价会很高。如果在某个选择性很低（哈希冲突很多）的列上建立哈希索引，那么当从表中删除一行时，存储引擎需要遍历对应哈希值的链表中的每一行，找到并删除对应行的引用，冲突越多，代价越大。

> InnoDB 引擎有一个特殊的功能叫做“自适应哈希索引（Adaptive hash index）”。当 InnoDB 注意到某些索引值被使用非常频繁时，它会在内存中基于 B-Tree 索引之上再创建一个哈希索引，这会让 B-Tree 索引也具有哈希索引的一些优点，比如快速哈希查找。这是一个完全自动的、内部行为。

**创建自定义哈希索引：**如果存储引擎不支持哈希索引，则可以模拟像 InnoDB 一样创建哈希索引。

创建思路：在 B-Tree 基础上创建一个伪哈希索引。这和真正的哈希索引不同，因为还是使用 B-Tree 进行查找，但是它使用哈希值而不是键本身进行索引查找。需要做的就是在查询 where 子句中手动指定使用哈希函数。

#### 空间数据索引 R-Tree

MyISAM 支持空间索引，可以用作地理数据存储

#### 全文索引

全文索引是一种特殊类型的索引，它查找的是文本中的关键词，而不是直接比较索引中的值。

# 索引的优点

1. 索引减少了服务器需要扫描的数据量。
2. 索引可以帮助服务器避免排序和临时表
3. 索引将随机 I/O 变为顺序 I/O。

# 高性能的索引策略

- 独立的列：索引列不能是表达式的一部分，也不能是函数的参数。

- 前缀索引：对于BLOB、TEXT 或者很长的 VARCHAR 列，使用前缀索引，对于前缀索引要选择足够长的前缀保证较高的选择性，计算选择性 `select count(distinct city) / count(*) from city_demo;` 针对不同的前缀长度计算选择性：

  ```
  select count(distinct left(city,3))/count(*) as sel3,
  		count(distinct left(city,4))/count(*) as sel4,
  		count(distinct left(city,5))/count(*) as sel5,
  		count(distinct left(city,6))/count(*) as sel6,
  		count(distinct left(city,7))/count(*) as sel7
  		from city_demo;
  ```

- 多列索引

- 选择合适的索引列顺序：索引列顺序意味着索引首先按照最左列进行排序，大部分的索引列顺序应该按照全局基数和选择性来选择。

- 聚簇索引：不是一种单独的索引类型，而是一种数据存储方式

- 覆盖索引：一个索引包含（也可以称为覆盖）所有需要查询的字段值

